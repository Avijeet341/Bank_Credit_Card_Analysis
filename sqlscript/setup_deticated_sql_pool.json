{
	"name": "setup_deticated_sql_pool",
	"properties": {
		"folder": {
			"name": "Bank_credit_card_analysis"
		},
		"content": {
			"query": "--------------------------------------------------------------------------------\n-- A.  CLEAN START: create schema if needed and drop old objects\n--------------------------------------------------------------------------------\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'BankCredit')\nBEGIN\n    EXEC('CREATE SCHEMA BankCredit');\nEND\nGO\n\nPRINT 'Schema BankCredit ensured';\n\n-- drop final tables if exist\nIF OBJECT_ID('BankCredit.dim_credit_history', 'U') IS NOT NULL DROP TABLE BankCredit.dim_credit_history;\nIF OBJECT_ID('BankCredit.fact_loans', 'U') IS NOT NULL DROP TABLE BankCredit.fact_loans;\nIF OBJECT_ID('BankCredit.dim_customers', 'U') IS NOT NULL DROP TABLE BankCredit.dim_customers;\nGO\n\n-- drop staging if present\nIF OBJECT_ID('BankCredit.stg_customers','U') IS NOT NULL DROP TABLE BankCredit.stg_customers;\nIF OBJECT_ID('BankCredit.stg_loans','U') IS NOT NULL DROP TABLE BankCredit.stg_loans;\nIF OBJECT_ID('BankCredit.stg_credit_history','U') IS NOT NULL DROP TABLE BankCredit.stg_credit_history;\nGO\n\n-- drop external tables (if any)\nIF OBJECT_ID('external_customers','U') IS NOT NULL DROP EXTERNAL TABLE external_customers;\nIF OBJECT_ID('external_loans','U') IS NOT NULL DROP EXTERNAL TABLE external_loans;\nIF OBJECT_ID('external_credit_history','U') IS NOT NULL DROP EXTERNAL TABLE external_credit_history;\nGO\n\n-- drop external data source and credential if exist (we will recreate)\nIF EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'bank_raw_data_adls')\n    DROP EXTERNAL DATA SOURCE bank_raw_data_adls;\nGO\n\nIF EXISTS (SELECT * FROM sys.database_scoped_credentials WHERE name = 'adls_sas_cred')\n    DROP DATABASE SCOPED CREDENTIAL adls_sas_cred;\nGO\n\nPRINT 'Old objects removed (if existed)';\nGO\n\n--------------------------------------------------------------------------------\n-- B.  CREATE FINAL (typed) TABLES (HEAP distribution chosen)\n--------------------------------------------------------------------------------\nCREATE TABLE BankCredit.dim_customers (\n    customer_id VARCHAR(10) NOT NULL,\n    age INT,\n    gender CHAR(1),\n    income DECIMAL(10,2),\n    employment_status VARCHAR(50),\n    years_employed INT,\n    city VARCHAR(50),\n    state VARCHAR(50),\n    created_date DATETIME NULL\n)\nWITH (DISTRIBUTION = REPLICATE, HEAP);\nGO\nPRINT 'dim_customers created';\n\nCREATE TABLE BankCredit.fact_loans (\n    loan_id VARCHAR(20) NOT NULL,\n    customer_id VARCHAR(10) NOT NULL,\n    loan_amount DECIMAL(12,2),\n    loan_purpose VARCHAR(50),\n    loan_term_months INT,\n    interest_rate DECIMAL(5,2),\n    issue_date DATE,\n    loan_status VARCHAR(50),\n    created_date DATETIME NULL\n)\nWITH (DISTRIBUTION = HASH(customer_id), HEAP);\nGO\nPRINT 'fact_loans created';\n\nCREATE TABLE BankCredit.dim_credit_history (\n    customer_id VARCHAR(10) NOT NULL,\n    credit_score INT,\n    num_credit_accounts INT,\n    total_credit_limit DECIMAL(12,2),\n    credit_utilization DECIMAL(5,2),\n    num_late_payments INT,\n    bankruptcies INT,\n    created_date DATETIME NULL\n)\nWITH (DISTRIBUTION = REPLICATE, HEAP);\nGO\nPRINT 'dim_credit_history created';\nGO\n\n--------------------------------------------------------------------------------\n-- C.  CREATE STAGING TABLES (all VARCHAR to avoid parse issues)\n--------------------------------------------------------------------------------\nCREATE TABLE BankCredit.stg_customers (\n    customer_id VARCHAR(500),\n    age VARCHAR(200),\n    gender VARCHAR(50),\n    income VARCHAR(200),\n    employment_status VARCHAR(200),\n    years_employed VARCHAR(200),\n    city VARCHAR(200),\n    state VARCHAR(200)\n) WITH (DISTRIBUTION = REPLICATE, HEAP);\nGO\n\nCREATE TABLE BankCredit.stg_loans (\n    loan_id VARCHAR(500),\n    customer_id VARCHAR(500),\n    loan_amount VARCHAR(200),\n    loan_purpose VARCHAR(200),\n    loan_term_months VARCHAR(200),\n    interest_rate VARCHAR(200),\n    issue_date VARCHAR(200),\n    loan_status VARCHAR(200)\n) WITH (DISTRIBUTION = HASH(customer_id), HEAP);\nGO\n\nCREATE TABLE BankCredit.stg_credit_history (\n    customer_id VARCHAR(500),\n    credit_score VARCHAR(200),\n    num_credit_accounts VARCHAR(200),\n    total_credit_limit VARCHAR(200),\n    credit_utilization VARCHAR(200),\n    num_late_payments VARCHAR(200),\n    bankruptcies VARCHAR(200)\n) WITH (DISTRIBUTION = REPLICATE, HEAP);\nGO\n\nPRINT 'Staging tables created';\nGO\n\n--------------------------------------------------------------------------------\n-- D.  MASTER KEY + OPEN (required for DB SCOPED CREDENTIAL)\n--     Create master key once, then open in session for credential creation.\n--------------------------------------------------------------------------------\n-- 1) create master key if not exists (run as db_owner)\nIF NOT EXISTS (SELECT * FROM sys.symmetric_keys WHERE name = '##MS_DatabaseMasterKey##')\nBEGIN\n    -- << replace password with a strong one >>\n    CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'ReplaceWithAStrongPassword!2025';\n    PRINT 'Database Master Key created';\nEND\nELSE\n    PRINT 'Database Master Key already exists';\nGO\n\n-- 2) open master key in this session (session-scoped)\nOPEN MASTER KEY DECRYPTION BY PASSWORD = 'ReplaceWithAStrongPassword!2025';\nGO\n\n--------------------------------------------------------------------------------\n-- E.  CREATE DATABASE SCOPED CREDENTIAL and EXTERNAL DATA SOURCE (SAS)\n--     Replace <YOUR_SAS_TOKEN_WITHOUT_QUESTIONMARK> with the SAS token string (no leading ?)\n--------------------------------------------------------------------------------\nCREATE DATABASE SCOPED CREDENTIAL adls_sas_cred\nWITH IDENTITY = 'SHARED ACCESS SIGNATURE',\nSECRET = 'sp=rl&st=2025-12-11T05:36:22Z&se=2025-12-11T13:51:22Z&spr=https&sv=2024-11-04&sr=c&sig=JgrTB7LsKjKjMO6BN7ccmZOrViOac2ibl6dS8hrBJFw%3D';\nGO\n\nCREATE EXTERNAL DATA SOURCE bank_raw_data_adls\nWITH (\n    TYPE = HADOOP,\n    LOCATION = 'abfss://bank-raw-data@kraftsynapse.dfs.core.windows.net/',\n    CREDENTIAL = adls_sas_cred\n);\nGO\n\nPRINT 'External data source and credential created';\nGO\n\n--------------------------------------------------------------------------------\n-- F.  EXTERNAL FILE FORMAT (CSV) - run once\n--------------------------------------------------------------------------------\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'fmt_csv')\nBEGIN\n    CREATE EXTERNAL FILE FORMAT fmt_csv\n    WITH (\n        FORMAT_TYPE = DELIMITEDTEXT,\n        FORMAT_OPTIONS (FIELD_TERMINATOR = ',', STRING_DELIMITER = '\"', FIRST_ROW = 2)\n    );\n    PRINT 'External file format fmt_csv created';\nEND\nELSE\n    PRINT 'External file format fmt_csv already exists';\nGO\n\n--------------------------------------------------------------------------------\n-- G.  CREATE EXTERNAL TABLES pointing to files inside the container\n--     Then INSERT into staging tables (this avoids COPY INTO permission issues)\n--------------------------------------------------------------------------------\n-- customers\nCREATE EXTERNAL TABLE external_customers\n(\n    customer_id VARCHAR(500),\n    age VARCHAR(200),\n    gender VARCHAR(200),\n    income VARCHAR(200),\n    employment_status VARCHAR(200),\n    years_employed VARCHAR(200),\n    city VARCHAR(200),\n    state VARCHAR(200)\n)\nWITH (\n    LOCATION = 'customers.csv',\n    DATA_SOURCE = bank_raw_data_adls,\n    FILE_FORMAT = fmt_csv\n);\nGO\n\nINSERT INTO BankCredit.stg_customers\nSELECT * FROM external_customers;\nGO\n\nSELECT 'stg_customers' AS table_name, COUNT(*) AS rows_loaded FROM BankCredit.stg_customers;\nGO\n\n-- loans\nCREATE EXTERNAL TABLE external_loans\n(\n    loan_id VARCHAR(500),\n    customer_id VARCHAR(500),\n    loan_amount VARCHAR(200),\n    loan_purpose VARCHAR(200),\n    loan_term_months VARCHAR(200),\n    interest_rate VARCHAR(200),\n    issue_date VARCHAR(200),\n    loan_status VARCHAR(200)\n)\nWITH (\n    LOCATION = 'loans.csv',\n    DATA_SOURCE = bank_raw_data_adls,\n    FILE_FORMAT = fmt_csv\n);\nGO\n\nINSERT INTO BankCredit.stg_loans\nSELECT * FROM external_loans;\nGO\n\nSELECT 'stg_loans' AS table_name, COUNT(*) AS rows_loaded FROM BankCredit.stg_loans;\nGO\n\n-- credit_history\nCREATE EXTERNAL TABLE external_credit_history\n(\n    customer_id VARCHAR(500),\n    credit_score VARCHAR(200),\n    num_credit_accounts VARCHAR(200),\n    total_credit_limit VARCHAR(200),\n    credit_utilization VARCHAR(200),\n    num_late_payments VARCHAR(200),\n    bankruptcies VARCHAR(200)\n)\nWITH (\n    LOCATION = 'credit_history.csv',\n    DATA_SOURCE = bank_raw_data_adls,\n    FILE_FORMAT = fmt_csv\n);\nGO\n\nINSERT INTO BankCredit.stg_credit_history\nSELECT * FROM external_credit_history;\nGO\n\nSELECT 'stg_credit_history' AS table_name, COUNT(*) AS rows_loaded FROM BankCredit.stg_credit_history;\nGO\n\n--------------------------------------------------------------------------------\n-- H.  TRANSFORM & LOAD: move from staging (VARCHAR) -> typed final tables\n--------------------------------------------------------------------------------\n-- customers -> dim_customers\nINSERT INTO BankCredit.dim_customers\n(customer_id, age, gender, income, employment_status, years_employed, city, state, created_date)\nSELECT\n    LTRIM(RTRIM(customer_id)),\n    TRY_CAST(age AS INT),\n    LTRIM(RTRIM(gender)),\n    TRY_CAST(REPLACE(REPLACE(income, '\"', ''), ',', '') AS DECIMAL(10,2)),\n    LTRIM(RTRIM(employment_status)),\n    TRY_CAST(years_employed AS INT),\n    LTRIM(RTRIM(city)),\n    LTRIM(RTRIM(state)),\n    GETDATE()\nFROM BankCredit.stg_customers;\nGO\n\n-- loans -> fact_loans\nINSERT INTO BankCredit.fact_loans\n(loan_id, customer_id, loan_amount, loan_purpose, loan_term_months, interest_rate, issue_date, loan_status, created_date)\nSELECT\n    LTRIM(RTRIM(loan_id)),\n    LTRIM(RTRIM(customer_id)),\n    TRY_CAST(REPLACE(REPLACE(loan_amount, '\"', ''), ',', '') AS DECIMAL(12,2)),\n    LTRIM(RTRIM(loan_purpose)),\n    TRY_CAST(loan_term_months AS INT),\n    TRY_CAST(interest_rate AS DECIMAL(5,2)),\n    TRY_CAST(issue_date AS DATE),\n    LTRIM(RTRIM(loan_status)),\n    GETDATE()\nFROM BankCredit.stg_loans;\nGO\n\n-- credit_history -> dim_credit_history\nINSERT INTO BankCredit.dim_credit_history\n(customer_id, credit_score, num_credit_accounts, total_credit_limit, credit_utilization, num_late_payments, bankruptcies, created_date)\nSELECT\n    LTRIM(RTRIM(customer_id)),\n    TRY_CAST(credit_score AS INT),\n    TRY_CAST(num_credit_accounts AS INT),\n    TRY_CAST(REPLACE(REPLACE(total_credit_limit, '\"', ''), ',', '') AS DECIMAL(12,2)),\n    TRY_CAST(credit_utilization AS DECIMAL(5,2)),\n    TRY_CAST(num_late_payments AS INT),\n    TRY_CAST(bankruptcies AS INT),\n    GETDATE()\nFROM BankCredit.stg_credit_history;\nGO\n\n--------------------------------------------------------------------------------\n-- I.  OPTIONAL: update created_date for all existing rows (safe idempotent)\n--------------------------------------------------------------------------------\nUPDATE BankCredit.dim_customers SET created_date = GETDATE();\nUPDATE BankCredit.fact_loans SET created_date = GETDATE();\nUPDATE BankCredit.dim_credit_history SET created_date = GETDATE();\nGO\n\n--------------------------------------------------------------------------------\n-- J.  CREATE VIEW for 360-degree customer (optional)\n--------------------------------------------------------------------------------\nIF OBJECT_ID('BankCredit.v_customer_360', 'V') IS NOT NULL\n    DROP VIEW BankCredit.v_customer_360;\nGO\n\nCREATE VIEW BankCredit.v_customer_360\nAS\nSELECT \n    c.customer_id,\n    c.age,\n    c.gender,\n    c.city,\n    c.state,\n    ch.credit_score,\n    ch.total_credit_limit,\n    l.loan_id,\n    l.loan_amount,\n    l.loan_status,\n    l.interest_rate\nFROM BankCredit.dim_customers c\nLEFT JOIN BankCredit.dim_credit_history ch \n    ON c.customer_id = ch.customer_id\nLEFT JOIN BankCredit.fact_loans l\n    ON c.customer_id = l.customer_id;\nGO\n\n--------------------------------------------------------------------------------\n-- K.  VERIFY counts & sample\n--------------------------------------------------------------------------------\nSELECT 'dim_customers' AS table_name, COUNT(*) FROM BankCredit.dim_customers;\nSELECT 'fact_loans' AS table_name, COUNT(*) FROM BankCredit.fact_loans;\nSELECT 'dim_credit_history' AS table_name, COUNT(*) FROM BankCredit.dim_credit_history;\nGO\n\nSELECT TOP (10) * FROM BankCredit.v_customer_360;\nGO\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "master",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}