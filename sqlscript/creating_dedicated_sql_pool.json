{
	"name": "creating_dedicated_sql_pool",
	"properties": {
		"content": {
			"query": "-- 1) Create schema and drop old tables (clean start)\nIF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'BankCredit')\n    EXEC('CREATE SCHEMA BankCredit');\nGO\n\nPRINT 'Schema BankCredit ensured';\n\nIF OBJECT_ID('BankCredit.dim_credit_history', 'U') IS NOT NULL DROP TABLE BankCredit.dim_credit_history;\nIF OBJECT_ID('BankCredit.fact_loans', 'U') IS NOT NULL DROP TABLE BankCredit.fact_loans;\nIF OBJECT_ID('BankCredit.dim_customers', 'U') IS NOT NULL DROP TABLE BankCredit.dim_customers;\n\n-- drop staging if present\nIF OBJECT_ID('BankCredit.stg_customers','U') IS NOT NULL DROP TABLE BankCredit.stg_customers;\nIF OBJECT_ID('BankCredit.stg_loans','U') IS NOT NULL DROP TABLE BankCredit.stg_loans;\nIF OBJECT_ID('BankCredit.stg_credit_history','U') IS NOT NULL DROP TABLE BankCredit.stg_credit_history;\nGO\n\nPRINT 'Old tables (final + staging) dropped if existed';\nGO\n\n\n-----------------------------------------------------------\n\n\n\n--step2\n\n\n\n-- 2) Create final typed tables (HEAP). created_date is nullable and will be populated later.\nCREATE TABLE BankCredit.dim_customers (\n    customer_id VARCHAR(10) NOT NULL,\n    age INT,\n    gender CHAR(1),\n    income DECIMAL(10,2),\n    employment_status VARCHAR(50),\n    years_employed INT,\n    city VARCHAR(50),\n    state VARCHAR(50),\n    created_date DATETIME NULL\n)\nWITH (DISTRIBUTION = REPLICATE, HEAP);\nGO\nPRINT 'dim_customers created';\n\nCREATE TABLE BankCredit.fact_loans (\n    loan_id VARCHAR(20) NOT NULL,\n    customer_id VARCHAR(10) NOT NULL,\n    loan_amount DECIMAL(12,2),\n    loan_purpose VARCHAR(50),\n    loan_term_months INT,\n    interest_rate DECIMAL(5,2),\n    issue_date DATE,\n    loan_status VARCHAR(50),\n    created_date DATETIME NULL\n)\nWITH (DISTRIBUTION = HASH(customer_id), HEAP);\nGO\nPRINT 'fact_loans created';\n\nCREATE TABLE BankCredit.dim_credit_history (\n    customer_id VARCHAR(10) NOT NULL,\n    credit_score INT,\n    num_credit_accounts INT,\n    total_credit_limit DECIMAL(12,2),\n    credit_utilization DECIMAL(5,2),\n    num_late_payments INT,\n    bankruptcies INT,\n    created_date DATETIME NULL\n)\nWITH (DISTRIBUTION = REPLICATE, HEAP);\nGO\nPRINT 'dim_credit_history created';\nGO\n\n\n\n---step3:\n\n-- 3) Create staging tables (all columns VARCHAR to avoid parse errors)\n\nCREATE TABLE BankCredit.stg_customers (\n    customer_id VARCHAR(500),\n    age VARCHAR(200),\n    gender VARCHAR(50),\n    income VARCHAR(200),\n    employment_status VARCHAR(200),\n    years_employed VARCHAR(200),\n    city VARCHAR(200),\n    state VARCHAR(200)\n) WITH (DISTRIBUTION = REPLICATE, HEAP);\nGO\n\nCREATE TABLE BankCredit.stg_loans (\n    loan_id VARCHAR(500),\n    customer_id VARCHAR(500),\n    loan_amount VARCHAR(200),\n    loan_purpose VARCHAR(200),\n    loan_term_months VARCHAR(200),\n    interest_rate VARCHAR(200),\n    issue_date VARCHAR(200),\n    loan_status VARCHAR(200)\n) WITH (DISTRIBUTION = HASH(customer_id), HEAP);\nGO\n\nCREATE TABLE BankCredit.stg_credit_history (\n    customer_id VARCHAR(500),\n    credit_score VARCHAR(200),\n    num_credit_accounts VARCHAR(200),\n    total_credit_limit VARCHAR(200),\n    credit_utilization VARCHAR(200),\n    num_late_payments VARCHAR(200),\n    bankruptcies VARCHAR(200)\n) WITH (DISTRIBUTION = REPLICATE, HEAP);\nGO\n\nPRINT 'Staging tables created';\nGO\n\n\n--step4:\n\n \n-- Drop old objects if exist\nIF EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'bank_raw_data_adls')\n    DROP EXTERNAL DATA SOURCE bank_raw_data_adls;\nGO\n\nIF EXISTS (SELECT * FROM sys.database_scoped_credentials WHERE name = 'adls_sas_cred')\n    DROP DATABASE SCOPED CREDENTIAL adls_sas_cred;\nGO\n\n-- Create credential using SAS token (NO ? at the beginning)\nCREATE DATABASE SCOPED CREDENTIAL adls_sas_cred\nWITH IDENTITY = 'SHARED ACCESS SIGNATURE',\nSECRET = 'sp=rl&st=2025-12-11T05:36:22Z&se=2025-12-11T13:51:22Z&spr=https&sv=2024-11-04&sr=c&sig=JgrTB7LsKjKjMO6BN7ccmZOrViOac2ibl6dS8hrBJFw%3D';\nGO\n\n-- Create external data source pointing to container\nCREATE EXTERNAL DATA SOURCE bank_raw_data_adls\nWITH (\n    TYPE = HADOOP,\n    LOCATION = 'abfss://bank-raw-data@kraftsynapse.dfs.core.windows.net/',\n    CREDENTIAL = adls_sas_cred\n);\nGO\n\n\n\n\nPRINT 'External data source created successfully';\n\n\n--step 5:\n\n-- COPY INTO staging tables\n\nCOPY INTO BankCredit.stg_customers\nFROM 'customers.csv'\nWITH (\n  DATA_SOURCE = 'bank_raw_data_adls',\n  FILE_TYPE = 'CSV',\n  FIRSTROW = 2,\n  FIELDTERMINATOR = ',',\n  ROWTERMINATOR = '0x0A'\n);\nGO\n\nPRINT '✅ COPY INTO BankCredit.stg_customers completed';\n\nCOPY INTO BankCredit.stg_loans\nFROM 'loans.csv'\nWITH (\n  DATA_SOURCE = 'bank_raw_data_adls',\n  FILE_TYPE = 'CSV',\n  FIRSTROW = 2,\n  FIELDTERMINATOR = ',',\n  ROWTERMINATOR = '0x0A'\n);\nGO\nPRINT '✅ COPY INTO BankCredit.stg_loans completed';\n\nCOPY INTO BankCredit.stg_credit_history\nFROM 'credit_history.csv'\nWITH (\n  DATA_SOURCE = 'bank_raw_data_adls',\n  FILE_TYPE = 'CSV',\n  FIRSTROW = 2,\n  FIELDTERMINATOR = ',',\n  ROWTERMINATOR = '0x0A'\n);\nGO\nPRINT '✅ COPY INTO BankCredit.stg_credit_history completed';\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "kraft100",
				"poolName": "kraft100"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}