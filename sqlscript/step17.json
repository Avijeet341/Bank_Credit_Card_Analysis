{
	"name": "step17",
	"properties": {
		"folder": {
			"name": "setup for  dedicated sql pool for test  bank data"
		},
		"content": {
			"query": "/* ==========================================================================\n   FULL DIAGNOSTIC + PATCH + ALERT SCRIPT (All-in-one)\n   - Basic QC: row counts, nulls, duplicates\n   - Referential integrity checks\n   - Samples inspection\n   - Create patched analytical view (deduplicated latest credit history)\n   - Defaulted-loans diagnostics (A-D) using patched view (no OFFSET)\n   - Alert if defaulted_count > threshold\n   - Final samples & summary\n   NOTE: Run connected to Dedicated SQL Pool (kraft100)\n   ========================================================================== */\n\nPRINT '=========================================================';\nPRINT ' FULL DIAGNOSTIC + PATCH + ALERT SCRIPT START';\nPRINT '=========================================================';\nGO\n\n-------------------------------------------\n-- PART 1: ROW COUNTS & BASIC DATA QUALITY\n-------------------------------------------\nPRINT '=========================================================';\nPRINT ' PART 1: ROW COUNTS & BASIC DATA QUALITY ';\nPRINT '=========================================================';\n\n-- Row counts\nSELECT table_name, row_count\nFROM (\n    SELECT 'dim_customers' AS table_name, COUNT(*) AS row_count FROM BankCredit.dim_customers\n    UNION ALL\n    SELECT 'fact_loans', COUNT(*) FROM BankCredit.fact_loans\n    UNION ALL\n    SELECT 'dim_credit_history', COUNT(*) FROM BankCredit.dim_credit_history\n) AS t;\nGO\n\n-- Null customer_id checks\nSELECT table_name, total_rows, null_customer_ids\nFROM (\n    SELECT 'dim_customers' AS table_name,\n           COUNT(*) AS total_rows,\n           SUM(CASE WHEN customer_id IS NULL THEN 1 ELSE 0 END) AS null_customer_ids\n    FROM BankCredit.dim_customers\n\n    UNION ALL\n\n    SELECT 'fact_loans',\n           COUNT(*),\n           SUM(CASE WHEN customer_id IS NULL THEN 1 ELSE 0 END)\n    FROM BankCredit.fact_loans\n\n    UNION ALL\n\n    SELECT 'dim_credit_history',\n           COUNT(*),\n           SUM(CASE WHEN customer_id IS NULL THEN 1 ELSE 0 END)\n    FROM BankCredit.dim_credit_history\n) AS t;\nGO\n\n-- Duplicate customers\nPRINT 'Checking duplicate customer_id in dim_customers (should be 0 rows)';\nSELECT customer_id, COUNT(*) AS occurrences\nFROM BankCredit.dim_customers\nGROUP BY customer_id\nHAVING COUNT(*) > 1;\nGO\n\n-------------------------------------------\n-- PART 2: REFERENTIAL INTEGRITY CHECKS\n-------------------------------------------\nPRINT '=========================================================';\nPRINT ' PART 2: REFERENTIAL INTEGRITY CHECKS ';\nPRINT '=========================================================';\n\nPRINT 'Loans referencing missing customers (if any):';\nSELECT DISTINCT customer_id \nFROM BankCredit.fact_loans\nWHERE customer_id NOT IN (SELECT customer_id FROM BankCredit.dim_customers);\nGO\n\nPRINT 'Credit history referencing missing customers (if any):';\nSELECT DISTINCT customer_id \nFROM BankCredit.dim_credit_history\nWHERE customer_id NOT IN (SELECT customer_id FROM BankCredit.dim_customers);\nGO\n\n-------------------------------------------\n-- PART 3: SAMPLE DATA\n-------------------------------------------\nPRINT '=========================================================';\nPRINT ' PART 3: SAMPLE DATA ';\nPRINT '=========================================================';\nPRINT 'Sample from dim_customers';\nSELECT TOP 5 * FROM BankCredit.dim_customers ORDER BY customer_id;\nGO\n\nPRINT 'Sample from fact_loans';\nSELECT TOP 5 * FROM BankCredit.fact_loans ORDER BY loan_id;\nGO\n\nPRINT 'Sample from dim_credit_history';\nSELECT TOP 5 * FROM BankCredit.dim_credit_history ORDER BY customer_id;\nGO\n\n-------------------------------------------\n-- PART 4: PATCH VIEW (DEDUP CREDIT HISTORY LATEST)\n-------------------------------------------\nPRINT '=========================================================';\nPRINT ' PART 4: PATCH VIEW (deduplicate credit history -> create patched view)';\nPRINT ' This prevents multiplication when dim_credit_history contains multiple rows per customer';\nPRINT '=========================================================';\n\n-- Drop patched view if it already exists\nIF OBJECT_ID('BankCredit.vw_customer_risk_profile_patched', 'V') IS NOT NULL\n    DROP VIEW BankCredit.vw_customer_risk_profile_patched;\nGO\n\n-- Create patched view using latest credit history per customer (by created_date desc)\nCREATE VIEW BankCredit.vw_customer_risk_profile_patched AS\nWITH ch_latest AS (\n    SELECT ch.*,\n           ROW_NUMBER() OVER (PARTITION BY customer_id \n                              ORDER BY COALESCE(created_date, '1900-01-01') DESC, credit_score DESC) AS rn\n    FROM BankCredit.dim_credit_history ch\n)\nSELECT \n    c.customer_id,\n    c.age,\n    c.gender,\n    c.income,\n    c.employment_status,\n    c.years_employed,\n    c.city,\n    c.state,\n    l.loan_id,\n    l.loan_amount,\n    l.loan_purpose,\n    l.loan_term_months,\n    l.interest_rate,\n    l.issue_date,\n    LTRIM(RTRIM(l.loan_status)) AS loan_status,\n    ch.credit_score,\n    ch.num_credit_accounts,\n    ch.total_credit_limit,\n    ch.credit_utilization,\n    ch.num_late_payments,\n    ch.bankruptcies,\n    CASE \n      WHEN TRY_CAST(l.loan_amount AS FLOAT) IS NULL OR TRY_CAST(c.income AS FLOAT) IS NULL OR TRY_CAST(c.income AS FLOAT) = 0 THEN NULL\n      ELSE TRY_CAST(l.loan_amount AS FLOAT) / NULLIF(TRY_CAST(c.income AS FLOAT), 0)\n    END AS debt_to_income_ratio,\n    CASE \n        WHEN ch.credit_score >= 750 AND COALESCE(ch.num_late_payments,0) = 0 AND COALESCE(ch.credit_utilization,0) < 30 THEN 'Low Risk'\n        WHEN ch.credit_score >= 650 AND COALESCE(ch.num_late_payments,0) <= 2 AND COALESCE(ch.credit_utilization,0) < 60 THEN 'Medium Risk'\n        ELSE 'High Risk'\n    END AS risk_category,\n    CASE \n        WHEN c.age IS NULL THEN 'Unknown'\n        WHEN c.age < 30 THEN 'Young (< 30)'\n        WHEN c.age BETWEEN 30 AND 40 THEN 'Mid (30-40)'\n        WHEN c.age BETWEEN 40 AND 50 THEN 'Mature (40-50)'\n        ELSE 'Senior (50+)'\n    END AS age_group,\n    CASE \n        WHEN c.income IS NULL THEN 'Unknown'\n        WHEN c.income < 50000 THEN 'Low (< 50K)'\n        WHEN c.income BETWEEN 50000 AND 75000 THEN 'Medium (50-75K)'\n        WHEN c.income BETWEEN 75000 AND 100000 THEN 'High (75-100K)'\n        ELSE 'Very High (100K+)'\n    END AS income_bracket\nFROM BankCredit.dim_customers c\nINNER JOIN BankCredit.fact_loans l ON c.customer_id = l.customer_id\nINNER JOIN (SELECT * FROM ch_latest WHERE rn = 1) ch ON c.customer_id = ch.customer_id;\nGO\n\nPRINT 'Patched view BankCredit.vw_customer_risk_profile_patched created (uses latest credit_history per customer)';\nGO\n\n-------------------------------------------\n-- PART 5: DEFAULTED LOANS DIAGNOSTICS (A - D) (NO OFFSET)\n-------------------------------------------\nPRINT '=========================================================';\nPRINT ' PART 5: DEFAULTED LOANS DIAGNOSTICS (A - D)';\nPRINT '=========================================================';\n\n-- A1: total defaulted loans count (using patched view)\nSELECT COUNT(*) AS defaulted_count\nFROM BankCredit.vw_customer_risk_profile_patched\nWHERE LOWER(LTRIM(RTRIM(loan_status))) = 'defaulted';\nGO\n\n-- A2: top defaulted records (inspect) - top 20\nSELECT TOP 20 customer_id, loan_id, loan_amount, loan_status, credit_score, credit_utilization,\n       debt_to_income_ratio, risk_category, age_group, income_bracket, city, state\nFROM BankCredit.vw_customer_risk_profile_patched\nWHERE LOWER(LTRIM(RTRIM(loan_status))) = 'defaulted'\nORDER BY credit_score ASC, credit_utilization DESC;\nGO\n\n-- B1: defaults by risk_category\nSELECT risk_category, COUNT(*) AS cnt\nFROM BankCredit.vw_customer_risk_profile_patched\nWHERE LOWER(LTRIM(RTRIM(loan_status))) = 'defaulted'\nGROUP BY risk_category\nORDER BY cnt DESC;\nGO\n\n-- B2: defaults by credit score bands\nSELECT \n  CASE \n    WHEN credit_score IS NULL THEN 'NULL'\n    WHEN credit_score < 550 THEN '<550'\n    WHEN credit_score BETWEEN 550 AND 649 THEN '550-649'\n    WHEN credit_score BETWEEN 650 AND 749 THEN '650-749'\n    ELSE '750+' END AS score_bucket,\n  COUNT(*) AS defaults\nFROM BankCredit.vw_customer_risk_profile_patched\nWHERE LOWER(LTRIM(RTRIM(loan_status))) = 'defaulted'\nGROUP BY\n  CASE \n    WHEN credit_score IS NULL THEN 'NULL'\n    WHEN credit_score < 550 THEN '<550'\n    WHEN credit_score BETWEEN 550 AND 649 THEN '550-649'\n    WHEN credit_score BETWEEN 650 AND 749 THEN '650-749'\n    ELSE '750+' END\nORDER BY defaults DESC;\nGO\n\n-- C1: Top cities/states with defaults - TOP 20 variant\nSELECT TOP 20 city, state, COUNT(*) AS defaults\nFROM BankCredit.vw_customer_risk_profile_patched\nWHERE LOWER(LTRIM(RTRIM(loan_status))) = 'defaulted'\nGROUP BY city, state\nORDER BY defaults DESC;\nGO\n\n-- C2: defaults by income bracket\nSELECT income_bracket, COUNT(*) AS defaults\nFROM BankCredit.vw_customer_risk_profile_patched\nWHERE LOWER(LTRIM(RTRIM(loan_status))) = 'defaulted'\nGROUP BY income_bracket\nORDER BY defaults DESC;\nGO\n\n-- D1: null/zero income or loan_amount among defaults + null scores/utilizations\nSELECT \n  SUM(CASE WHEN income IS NULL OR TRY_CAST(income AS FLOAT) = 0 THEN 1 ELSE 0 END) AS null_or_zero_income,\n  SUM(CASE WHEN loan_amount IS NULL OR TRY_CAST(loan_amount AS FLOAT) = 0 THEN 1 ELSE 0 END) AS null_or_zero_loan_amount,\n  SUM(CASE WHEN credit_utilization IS NULL THEN 1 ELSE 0 END) AS null_utilization,\n  SUM(CASE WHEN credit_score IS NULL THEN 1 ELSE 0 END) AS null_credit_score\nFROM BankCredit.vw_customer_risk_profile_patched\nWHERE LOWER(LTRIM(RTRIM(loan_status))) = 'defaulted';\nGO\n\n-- D2: duplicate loan_id check among defaults (to detect multiplication)\nSELECT loan_id, COUNT(*) AS cnt\nFROM BankCredit.vw_customer_risk_profile_patched\nWHERE LOWER(LTRIM(RTRIM(loan_status))) = 'defaulted'\nGROUP BY loan_id\nHAVING COUNT(*) > 1;\nGO\n\n-------------------------------------------\n-- PART 6: ALERT - Raise error if defaulted_count > threshold\n-------------------------------------------\nPRINT '=========================================================';\nPRINT ' PART 6: ALERT CHECK (raise error if defaults exceed threshold)';\nPRINT '=========================================================';\n\nDECLARE @defaults INT;\nSELECT @defaults = COUNT(*) FROM BankCredit.vw_customer_risk_profile_patched\nWHERE LOWER(LTRIM(RTRIM(loan_status))) = 'defaulted';\n\n-- set your threshold here\nDECLARE @threshold INT = 150;\n\nPRINT 'Defaulted loans count: ' + CAST(@defaults AS VARCHAR(10));\nPRINT 'Alert threshold is: ' + CAST(@threshold AS VARCHAR(10));\n\nIF @defaults > @threshold\nBEGIN\n    RAISERROR('ALERT: Defaulted loans count (%d) exceeds threshold (%d)', 16, 1, @defaults, @threshold);\nEND\nELSE\nBEGIN\n    PRINT 'Defaulted loans count is within threshold.';\nEND\nGO\n\n-------------------------------------------\n-- PART 7: OPTIONAL final checks & summary\n-------------------------------------------\nPRINT '=========================================================';\nPRINT ' PART 7: FINAL SAMPLE & SUMMARY ';\nPRINT '=========================================================';\n\nPRINT 'Top 10 risk-profile rows (patched view)';\nSELECT TOP 10 customer_id, loan_id, loan_amount, loan_status, credit_score, credit_utilization, risk_category, debt_to_income_ratio\nFROM BankCredit.vw_customer_risk_profile_patched\nORDER BY risk_category, credit_score DESC;\nGO\n\nPRINT '=========================================================';\nPRINT ' SCRIPT COMPLETE';\nPRINT '=========================================================';\nGO\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "kraft100",
				"poolName": "kraft100"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}