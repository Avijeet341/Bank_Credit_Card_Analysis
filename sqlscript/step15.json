{
	"name": "step15",
	"properties": {
		"folder": {
			"name": "setup for  dedicated sql pool for test  bank data"
		},
		"content": {
			"query": "--------------------------------------------------------------------------------\n-- DATA QUALITY & VALIDATION SCRIPT FOR BANKCREDIT DATA WAREHOUSE\n-- This script validates:\n-- 1. Row counts\n-- 2. Null & data integrity issues\n-- 3. Duplicate keys\n-- 4. Referential integrity between dimensions and facts\n-- 5. Sample data extraction\n-- 6. 360-degree view validation\n-- 7. Risk profile validation\n-- 8. Defaulted loan analysis\n-- 9. Data range quality checks\n-- 10. Missing risk category checks\n--------------------------------------------------------------------------------\n\n\nPRINT '=========================================================';\nPRINT ' STEP 1: ROW COUNT VALIDATION ';\nPRINT '=========================================================';\nSELECT table_name, row_count\nFROM (\n    SELECT 'dim_customers' AS table_name, COUNT(*) AS row_count FROM BankCredit.dim_customers\n    UNION ALL\n    SELECT 'fact_loans', COUNT(*) FROM BankCredit.fact_loans\n    UNION ALL\n    SELECT 'dim_credit_history', COUNT(*) FROM BankCredit.dim_credit_history\n) AS t;\nGO\n\n\n\nPRINT '=========================================================';\nPRINT ' STEP 2: NULL CUSTOMER_ID CHECKS (DATA INTEGRITY) ';\nPRINT '=========================================================';\nSELECT table_name, total_rows, null_customer_ids\nFROM (\n    SELECT 'dim_customers' AS table_name,\n           COUNT(*) AS total_rows,\n           SUM(CASE WHEN customer_id IS NULL THEN 1 ELSE 0 END) AS null_customer_ids\n    FROM BankCredit.dim_customers\n\n    UNION ALL\n\n    SELECT 'fact_loans',\n           COUNT(*),\n           SUM(CASE WHEN customer_id IS NULL THEN 1 ELSE 0 END)\n    FROM BankCredit.fact_loans\n\n    UNION ALL\n\n    SELECT 'dim_credit_history',\n           COUNT(*),\n           SUM(CASE WHEN customer_id IS NULL THEN 1 ELSE 0 END)\n    FROM BankCredit.dim_credit_history\n) AS t;\nGO\n\n\n\nPRINT '=========================================================';\nPRINT ' STEP 3: DUPLICATE CUSTOMER_ID CHECK IN DIM_CUSTOMERS ';\nPRINT '=========================================================';\nSELECT customer_id, COUNT(*) AS occurrences\nFROM BankCredit.dim_customers\nGROUP BY customer_id\nHAVING COUNT(*) > 1;\nGO\n\n\n\nPRINT '=========================================================';\nPRINT ' STEP 4: REFERENTIAL INTEGRITY CHECKS ';\nPRINT ' Checking if fact tables reference non-existing customers ';\nPRINT '=========================================================';\n\n-- 4A. Loans with missing customer reference\nSELECT DISTINCT customer_id \nFROM BankCredit.fact_loans\nWHERE customer_id NOT IN (SELECT customer_id FROM BankCredit.dim_customers);\nGO\n\n-- 4B. Credit history with missing customer reference\nSELECT DISTINCT customer_id \nFROM BankCredit.dim_credit_history\nWHERE customer_id NOT IN (SELECT customer_id FROM BankCredit.dim_customers);\nGO\n\n\n\nPRINT '=========================================================';\nPRINT ' STEP 5: SAMPLE DATA FROM EACH TABLE ';\nPRINT '=========================================================';\n\nPRINT 'Sample from dim_customers';\nSELECT TOP 5 * FROM BankCredit.dim_customers ORDER BY customer_id;\n\nPRINT 'Sample from fact_loans';\nSELECT TOP 5 * FROM BankCredit.fact_loans ORDER BY loan_id;\n\nPRINT 'Sample from dim_credit_history';\nSELECT TOP 5 * FROM BankCredit.dim_credit_history ORDER BY customer_id;\nGO\n\n\n\nPRINT '=========================================================';\nPRINT ' STEP 6: VALIDATE 360-DEGREE VIEW ';\nPRINT '=========================================================';\nSELECT TOP 10 * \nFROM BankCredit.v_customer_360\nORDER BY customer_id;\nGO\n\n\n\nPRINT '=========================================================';\nPRINT ' STEP 7: VALIDATE RISK PROFILE ANALYTICAL VIEW ';\nPRINT '=========================================================';\nSELECT TOP 10 *\nFROM BankCredit.vw_customer_risk_profile\nORDER BY customer_id;\nGO\n\n\n\nPRINT '=========================================================';\nPRINT ' STEP 8: DEFAULTED LOAN ANALYSIS (HIGH-RISK IDENTIFICATION) ';\nPRINT '=========================================================';\nSELECT \n    customer_id,\n    loan_id,\n    loan_amount,\n    loan_status,\n    credit_score,\n    credit_utilization,\n    debt_to_income_ratio,\n    risk_category,\n    age_group,\n    income_bracket\nFROM BankCredit.vw_customer_risk_profile\nWHERE loan_status = 'Defaulted'\nORDER BY credit_score ASC, credit_utilization DESC;\nGO\n\n\n\nPRINT '=========================================================';\nPRINT ' STEP 9: DATA RANGE VALIDATION (QUALITY CHECKS) ';\nPRINT '=========================================================';\nSELECT \n    MIN(credit_score) AS min_credit_score,\n    MAX(credit_score) AS max_credit_score,\n    MIN(income) AS min_income,\n    MAX(income) AS max_income,\n    MIN(credit_utilization) AS min_utilization,\n    MAX(credit_utilization) AS max_utilization\nFROM BankCredit.vw_customer_risk_profile;\nGO\n\n\n\nPRINT '=========================================================';\nPRINT ' STEP 10: CHECK FOR MISSING RISK CATEGORIES ';\nPRINT '=========================================================';\nSELECT *\nFROM BankCredit.vw_customer_risk_profile\nWHERE risk_category IS NULL;\nGO\n\n\n\nPRINT '=========================================================';\nPRINT '  DATA VALIDATION COMPLETE ✔ ';\nPRINT '=========================================================';\n\n\n\n---out-put:\n/*\n1) Quick interpretation of the run output\n\nStep 1 Row counts: 3 records affected — means the three tables returned their counts. (Good.)\n\nStep 2 Null ID checks: 3 records affected — null-check ran for three tables. No immediate error reported.\n\nStep 3 Duplicates: 0 record affected — no duplicate customer_id found in dim_customers. Good.\n\nStep 4 Referential integrity: 0 record affected — no loans or credit history referencing missing customers. Good.\n\nStep 5 Samples: samples returned for each table. Good.\n\nStep 6 & 7 Views: both views returned rows. Good.\n\nStep 8 Defaulted loans: 190 records affected — this is the only surprising item (you previously expected ~100).\nThat means 190 rows in the risk view have loan_status = 'Defaulted'.\n\nStep 9 Data range checks: ran (1 record) — outputs present (min/max).\n\nStep 10 Missing risk categories: 0 — all rows have a risk_category.\n\nSo overall the ETL looks healthy — the main issue to investigate is why 190 defaults (higher than expected).\n*/\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "kraft100",
				"poolName": "kraft100"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}